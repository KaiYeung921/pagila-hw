name: tests
on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build and Run Docker
        run: |
          # 1. Start containers
          docker-compose up -d --build

          # 2. Wait for Postgres to be "Ready"
          # Instead of just sleeping, we wait for the port to open
          timeout 60s bash -c 'until docker-compose exec -T pg pg_isready -U postgres; do sleep 2; done'

          # 3. Run the test query
          # We use the password 'pass' from your docker-compose.yml
          docker-compose exec -T pg psql -U postgres -d postgres -c "SELECT 1;"
