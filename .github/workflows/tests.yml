name: tests
on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      # Modern checkout handles submodules automatically
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build and Run Docker
        run: |
          # Start the containers
          docker-compose up -d --build

          # Debugging: show container status
          docker ps -a

          # Wait for PostgreSQL to initialize and load Pagila data
          # If 20s isn't enough, we can implement a "healthcheck" loop later
          sleep 20

          # REAL TEST: Check if the 'actor' table exists and has data
          # This replaces the non-existent fixme.sh
          docker-compose exec -T pg psql -U postgres -d pagila -c "SELECT count(*) FROM actor;"
